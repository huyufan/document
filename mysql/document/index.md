# 索引 帮助存储引擎快速获取数据的一种数据结构 索引就是数据的目录
## 按\[数据结构\] 分类: B+tree 索引， hash 索引  full-text 索引
## 按\[物理存储\] 分类: 聚集索引（主键索引） 二级索引（辅助索引）
## 按\[字段特性\] 分类: 主键索引 唯一索引 普通索引 前缀索引
## 按\[字段个数\] 分类: 单例索引  联合索引

### 在创建表的时候 INNODB 存储引擎会根据不同场景选择不同的类作为索引
#### 如果有主键 默认会使用主键作为聚簇索引的索引键
#### 如果没有主键 就选择第一个不包含Null值的唯一列作为聚簇索引的索引键
#### 在上面都没有 会自动生成一个隐式自增id列作为聚簇索引的索引键

### B+tree
#### B+tree 是一种多叉树，叶子节点存放数据，非叶子节点只存放索引，而且每个节点里的数据都是按主键顺序存放的 每一层父节点的索引值都会出现在下层子节点的索引值中，包括了所以的索引值信息，并且每一个叶子节点都有两个指针，分别指向下一个叶子节点和上一个叶子节点，形成了一个双向链表
### B+Tree 相比与 B树 和二叉树来说，最大的优势是查询效率高，因为即使在数据量很大的情况，查询一个数据的磁盘i/o 也就3次
### 主键索引叶子节点 存放的实际数据  二级索引存放的是主键值 

### 如果我用二级索引查询商品
``` mysql
select * from product where product_no='0002'
```
### 会先捡二级索引中的B+tree 的索引值 找到对应的叶子节点，然后获取主键值，然后通过主键索引中的B+Tree 找对应的叶子节点 获取数据  这个叫回表
``` mysql
select id from product where product_no='0002'
```
### 这种在二级索引的B+tree 就能查询到结果的过程叫\[覆盖索引\]


## B+Tree 和b树和二叉树 和hash索引结构
### B+Tree 只在叶子节点存储数据  而 B树的非叶子节点也要存储数据，所以B+Tree 的单个节点的数量更少，在相同的磁盘io下，能查询更多节点
### B+Tree 叶子节点采用的是双链表连接， 适合 mysql中常见的基于范围的顺序查询，而B树无法做到这一点
### 二叉树的每个父节点的儿子节点个数只能有2个
### Hash 在做等值查询的效率的很快O(1)  不合适范围查询


## 联合索引 存在最左匹配原则
### 如果创建了一个(a,b,c)的联合索引
### 需要注意的是，因为有查询优化器，所以a字段在where子句中的顺序不重要 
### b 和 c 全局是无序的 局部是有序的

### 区分度 = distinct(column)/count(*)


# MySQL 单表不要超过 2000W 行，靠谱吗？

## 这张表数据，在硬盘上存储也是类似如此的，它实际是放在一个叫 person.ibd （innodb data）的文件中，也叫做表空间；虽然数据表中，他们看起来是一条连着一条，但是实际上在文件中它被分成很多小份的数据页，而且每一份都是 16K。
## 大概就像下面这样，当然这只是我们抽象出来的，在表空间中还有段、区、组等很多概念，但是我们需要跳出来看。

## 单表建议值
- 非叶子节点内指向其他页的数量为 x
- 叶子节点内能容纳的数据行数为 y
- B+ 数的层数为 z

### Total =x^(z-1) *y 也就是说总数会等于 x 的 z-1 次方 与 Y 的乘积

#### x =?
- 已经介绍了页的结构，索引也也不例外，都会有 File Header (38 byte)、Page Header (56 Byte)、Infimum + Supermum（26 byte）、File Trailer（8byte）, 再加上页目录，大概 1k 左右。
- 我们就当做它就是 1K, 那整个页的大小是 16K, 剩下 15k 用于存数据，在索引页中主要记录的是主键与页号，主键我们假设是 Bigint (8 byte), 而页号也是固定的（4Byte）, 那么索引页中的一条数据也就是 12byte。
##### **所以 x=15*1024/12≈1280 行。**

#### Y=?
- 叶子节点和非叶子节点的结构是一样的，同理，能放数据的空间也是 15k。
- 但是叶子节点中存放的是真正的行数据，这个影响的因素就会多很多，比如，字段的类型，字段的数量。每行数据占用空间越大，页中所放的行数量就会越少。
- 这边我们暂时按一条行数据 1k 来算，那一页就能存下 15 条，Y = 15*1024/1000  ≈15。
- 根据上述的公式，Total =x^(z-1) *y，已知 x=1280，y=15：

- 假设 B+ 树是两层，那就是 z = 2， Total = （1280 ^1 ）*15 = 19200
- 假设 B+ 树是两层，那就是 z = 3， Total = （1280 ^2 ）*15 = 24576000


## 索引使用情况
- show status like 'handler_read%'
### 注意
- handler_read_key 这个值越高越好，越高表示使用索引查询到的次数
- handler_read_rnd_next 这个值越高，说明查询低效


